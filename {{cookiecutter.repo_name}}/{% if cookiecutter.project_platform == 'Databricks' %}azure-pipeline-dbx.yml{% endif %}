trigger:
  branches:
    include: [stage, main] # pipeline triggers on stage and main branches

pool:
  name: 'GR_CLOUD_MEGA' # the GR_CLOUD_MEGA self-hosted agent is used

steps:
  - checkout: self

  - powershell: |
      # point PATH to your local CLI
      $env:PATH = "D:\digic_gr_ai\databrickscli;$env:PATH"
      databricks.exe version

      # map branch -> target and token
      if ("$(Build.SourceBranchName)" -eq "stage") {
        $env:BUNDLE_TARGET = "stage"
        $env:DATABRICKS_TOKEN = "$(DATABRICKS_STAGE_TOKEN)"
      }
      elseif ("$(Build.SourceBranchName)" -eq "main") {
        $env:BUNDLE_TARGET = "prod"
        $env:DATABRICKS_TOKEN = "$(DATABRICKS_PROD_TOKEN)"
      }
      else {
        Write-Host "Not a deployment branch"; exit 1
      }

      Write-Host "Target: $env:BUNDLE_TARGET"

      # validate, deploy, & execute
      databricks.exe bundle validate -t $env:BUNDLE_TARGET --debug
      databricks.exe bundle deploy   -t $env:BUNDLE_TARGET
      databricks.exe bundle run -t $env:BUNDLE_TARGET database-init-job
    displayName: 'Validate, deploy, & execute DAB'